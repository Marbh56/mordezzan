{{define "title"}}{{.Character.Name}} - Character Details - Mordezzan{{end}}
{{define "content"}}
<div>
    <h1>{{.Character.Name}}</h1>

    <!-- Character Actions -->
    <div class="quick-actions">
        <a href="/characters/edit?id={{.Character.ID}}">Edit Character</a>
        {{if eq .Character.Class "Fighter"}}
        <a href="/characters/masteries?id={{.Character.ID}}"
            >Manage Weapon Masteries</a
        >
        {{end}}
        <form action="/characters/delete" method="POST" style="display: inline">
            <input
                type="hidden"
                name="character_id"
                value="{{.Character.ID}}"
            />
            <button
                type="submit"
                onclick="return confirm('Are you sure you want to delete this character?')"
            >
                Delete Character
            </button>
        </form>
    </div>

    {{if .FlashMessage}}
    <div>{{.FlashMessage}}</div>
    {{end}}

    <!-- Basic Stats -->
    <div>
        <h2>Hit Points</h2>
        <div>{{.Character.CurrentHp}} / {{.Character.MaxHp}}</div>
    </div>

    <div class="character-xp">
        <h2>Experience</h2>
        <div class="xp-details">
            <div>Current XP: {{.Character.ExperiencePoints}}</div>
            <div>Next Level: {{.Character.NextLevelXP}}</div>
            <div>XP Needed: {{.Character.XPNeeded}}</div>
        </div>
    </div>

    <!-- Ability Scores -->
    <div>
        <h2>Ability Scores</h2>
        <div>
            <h3>Strength: {{.Character.Strength}}</h3>
            <ul>
                <li>
                    Attack (Melee): {{if ge
                    .Character.StrengthModifiers.AttackMod
                    0}}+{{end}}{{.Character.StrengthModifiers.AttackMod}}
                </li>
                <li>
                    Damage: {{if ge .Character.StrengthModifiers.DamageMod
                    0}}+{{end}}{{.Character.StrengthModifiers.DamageMod}}
                </li>
                <li>
                    Test of Strength:
                    {{.Character.StrengthModifiers.TestOfStrength}}
                </li>
                <li>
                    Extraordinary Feat:
                    {{.Character.StrengthModifiers.ExtraordinaryFeat}}%
                </li>
            </ul>

            <h3>Dexterity: {{.Character.Dexterity}}</h3>
            <ul>
                <li>
                    Attack (Missile): {{if ge
                    .Character.DexterityModifiers.AttackMod
                    0}}+{{end}}{{.Character.DexterityModifiers.AttackMod}}
                </li>
                <li>
                    Defense: {{if ge .Character.DexterityModifiers.DefenseAdj
                    0}}+{{end}}{{.Character.DexterityModifiers.DefenseAdj}}
                </li>
                <li>
                    Test of Dexterity:
                    {{.Character.DexterityModifiers.TestOfDexterity}}
                </li>
                <li>
                    Extraordinary Feat:
                    {{.Character.DexterityModifiers.ExtraordinaryFeat}}%
                </li>
            </ul>

            <h3>Constitution: {{.Character.Constitution}}</h3>
            <ul>
                <li>
                    Hit Points/Level: {{if ge
                    .Character.ConstitutionModifiers.HitPointMod
                    0}}+{{end}}{{.Character.ConstitutionModifiers.HitPointMod}}
                </li>
                <li>
                    Poison/Radiation: {{if ge
                    .Character.ConstitutionModifiers.PoisonRadMod
                    0}}+{{end}}{{.Character.ConstitutionModifiers.PoisonRadMod}}
                </li>
                <li>
                    Trauma Survival:
                    {{.Character.ConstitutionModifiers.TraumaSurvival}}%
                </li>
                <li>
                    Test of Constitution:
                    {{.Character.ConstitutionModifiers.TestOfCon}}
                </li>
                <li>
                    Extraordinary Feat:
                    {{.Character.ConstitutionModifiers.ExtraordinaryFeat}}%
                </li>
            </ul>

            <h3>Intelligence: {{.Character.Intelligence}}</h3>
            <ul>
                <li>
                    Languages: {{.Character.IntelligenceModifiers.Languages}}
                    additional
                </li>
                <li>
                    Bonus Spell Level:
                    {{.Character.IntelligenceModifiers.BonusSpellLevel}}
                </li>
                <li>
                    Chance to Learn:
                    {{.Character.IntelligenceModifiers.ChanceToLearn}}%
                </li>
                <li>
                    Literate: {{if
                    .Character.IntelligenceModifiers.IsLiterate}}Yes{{else}}No{{end}}
                </li>
            </ul>

            <h3>Wisdom: {{.Character.Wisdom}}</h3>
            <ul>
                <li>
                    Willpower Adjustment: {{if ge
                    .Character.WisdomModifiers.WillpowerAdj
                    0}}+{{end}}{{.Character.WisdomModifiers.WillpowerAdj}}
                </li>
                <li>
                    Bonus Spell Level:
                    {{.Character.WisdomModifiers.BonusSpellLevel}}
                </li>
                <li>
                    Spell Learning Chance:
                    {{.Character.WisdomModifiers.SpellLearningChance}}%
                </li>
            </ul>

            <h3>Charisma: {{.Character.Charisma}}</h3>
            <ul>
                <li>
                    Reaction/Loyalty Adjustment: {{if ge
                    .Character.CharismaModifiers.ReactionLoyaltyAdj
                    0}}+{{end}}{{.Character.CharismaModifiers.ReactionLoyaltyAdj}}
                </li>
                <li>
                    Maximum Henchmen:
                    {{.Character.CharismaModifiers.MaxHenchmen}}
                </li>
                <li>
                    Undead Turning Adjustment: {{if ge
                    .Character.CharismaModifiers.UndeadTurningAdj
                    0}}+{{end}}{{.Character.CharismaModifiers.UndeadTurningAdj}}
                </li>
            </ul>
        </div>
    </div>

    <div>
        <h2>Saving Throws</h2>
        <p>Base Target: {{.Character.SavingThrow}}+ on d20</p>

        {{$classModifiers := GetSavingThrowModifiers .Character.Class}}
        <table class="saving-throws">
            <tr>
                <th>Type</th>
                <th>Modifier</th>
                <th>Final Target</th>
            </tr>
            <tr>
                <td>Death</td>
                <td>
                    {{if ge $classModifiers.Death
                    0}}+{{end}}{{$classModifiers.Death}}
                </td>
                <td>{{add .Character.SavingThrow $classModifiers.Death}}</td>
            </tr>
            <tr>
                <td>Transformation</td>
                <td>
                    {{if ge $classModifiers.Transformation
                    0}}+{{end}}{{$classModifiers.Transformation}}
                </td>
                <td>
                    {{add .Character.SavingThrow
                    $classModifiers.Transformation}}
                </td>
            </tr>
            <tr>
                <td>Device</td>
                <td>
                    {{if ge $classModifiers.Device
                    0}}+{{end}}{{$classModifiers.Device}}
                </td>
                <td>{{add .Character.SavingThrow $classModifiers.Device}}</td>
            </tr>
            <tr>
                <td>Avoidance</td>
                <td>
                    {{if ge $classModifiers.Avoidance
                    0}}+{{end}}{{$classModifiers.Avoidance}}
                </td>
                <td>
                    {{add .Character.SavingThrow $classModifiers.Avoidance}}
                </td>
            </tr>
            <tr>
                <td>Sorcery</td>
                <td>
                    {{if ge $classModifiers.Sorcery
                    0}}+{{end}}{{$classModifiers.Sorcery}}
                </td>
                <td>{{add .Character.SavingThrow $classModifiers.Sorcery}}</td>
            </tr>
        </table>
    </div>

    <div>
        <h2>Class Abilities</h2>
        {{if eq .Character.Class "Fighter"}}
        <details>
            <summary>Heroic Fighting</summary>
            <p>
                To smite multiple foes. When combating opponents of 1 Hit Dice
                or less, double normal melee attacks per round (2/1, or 3/1 if
                weilding a mastered weapon). This dramatic attack could be
                effected as a single, devastating swing or lunge that burst
                through multiple foes.
            </p>
            <p>
                At 7th level, when combating foes of 2 HD or less, double normal
                melee attacks per round (3/1, or 4/1 if wielding a mastered
                weapon)
            </p>
        </details>
        <details>
            <summary>Weapon Mastery</summary>
            <p>
                Master of two weapons (+1 "to hit" and +1 damage). Additional
                weapons may be mastered at 4th, 8th, and 12th levels; however,
                see grand mastery below, for another option. The attack rate for
                melee weapons and the rates of fire for most missile weapons
                imporve through weapon mastery.
            </p>
        </details>
        <details>
            <summary>Grand Mastery</summary>
            <p>
                At 4th, 8th, or 12th level (players choice), when a new wepaon
                mastery is gained, fighters may elect to intensify their
                training with an already mastered weapon. With this weapon the
                fighter becomes a grand master (+2 "to hit" and +2 damage,
                increased attack rate etc.) A fighter may achieve grand mastery
                with but one weapon.
            </p>
        </details>
        {{else if eq .Character.Class "Thief"}}
        <details>
            <summary>Backstab</summary>
            <p>
                When attacking unaware opponents from behind, you deal double
                damage. This multiplier increases to ×3 at 5th level and ×4 at
                9th level.
            </p>
        </details>
        <details>
            <summary>Thief Skills</summary>
            <p>
                You have special abilities that improve as you gain levels: Open
                Locks, Remove Traps, Pick Pockets, Move Silently, Climb Walls,
                Hide in Shadows.
            </p>
        </details>
        {{else if eq .Character.Class "Cleric"}}
        <details>
            <summary>Turn Undead</summary>
            <p>
                As an action, you can attempt to turn undead creatures within 60
                feet. The effectiveness improves as you gain levels.
            </p>
        </details>
        <details>
            <summary>Divine Magic</summary>
            <p>
                You can cast divine spells. Your spell slots increase as you
                gain levels.
            </p>
        </details>
        {{else if eq .Character.Class "Magician"}}
        <details>
            <summary>Arcane Magic</summary>
            <p>
                You can cast arcane spells. Your spell slots increase as you
                gain levels.
            </p>
        </details>
        <details>
            <summary>Arcane Research</summary>
            <p>
                You can research new spells and create magic scrolls when you
                have the time and resources.
            </p>
        </details>
        {{end}}
    </div>

    <!-- Combat -->
    <div>
        <h2>Combat Matrix</h2>
        <table border="1">
            <tr>
                <th>AC</th>
                {{range $i := seq -9 9}}
                <th>{{$i}}</th>
                {{end}}
            </tr>
            <tr>
                <td>Target</td>
                {{range $tn := .Character.CombatMatrix}}
                <td>{{$tn}}</td>
                {{end}}
            </tr>
        </table>
    </div>

    <div>
        <h2>Equipped Weapons</h2>
        <div class="weapons-grid">
            {{range .Character.EquippedItems}} {{if or (eq .ItemType "weapon")
            (eq .ItemType "ranged_weapon")}}
            <div class="weapon-entry">
                <h3>{{.ItemName}}</h3>
                <div class="weapon-details">
                    <!-- Base Damage + Modifiers -->
                    <!-- Debug: ItemType={{.ItemType}} Damage={{.Damage.String}} Valid={{.Damage.Valid}} -->
                    {{if .Damage.Valid}}
                    <p>
                        <strong>Damage:</strong> {{.Damage.String}} {{if eq
                        .ItemType "weapon"}} {{with
                        $.Character.StrengthModifiers}} {{if gt .DamageMod
                        0}}+{{.DamageMod}}{{end}} {{if lt .DamageMod
                        0}}{{.DamageMod}}{{end}} {{end}} {{end}}
                    </p>
                    {{end}}

                    <!-- To Hit Bonus -->
                    <p>
                        <strong>To Hit:</strong>
                        {{if eq .ItemType "weapon"}} {{with
                        $.Character.StrengthModifiers}} {{if gt .AttackMod
                        0}}+{{.AttackMod}}{{end}} {{if lt .AttackMod
                        0}}{{.AttackMod}}{{end}} {{end}} {{else}} {{with
                        $.Character.DexterityModifiers}} {{if gt .AttackMod
                        0}}+{{.AttackMod}}{{end}} {{if lt .AttackMod
                        0}}{{.AttackMod}}{{end}} {{end}} {{end}}
                    </p>

                    <!-- Attack Rate -->
                    {{if .AttacksPerRound.Valid}}
                    <p>
                        <strong>Attacks per Round:</strong>
                        {{.AttacksPerRound.String}}
                    </p>
                    {{end}}
                </div>
            </div>
            {{end}} {{end}}
        </div>
    </div>
    <!-- Inventory Section -->
    <div>
        <div>
            <h2>Inventory</h2>
            <a href="/characters/inventory/add?character_id={{.Character.ID}}"
                >Add Item</a
            >
        </div>

        <!-- Encumbrance Information -->
        <div>
            <h3>Encumbrance Status</h3>
            <p>Total Weight: {{.Character.InventoryStats.TotalWeight}} lbs</p>
            <p>Status: {{.Character.InventoryStats.EncumbranceLevel}}</p>
            <p>
                Encumbered at: {{.Character.InventoryStats.BaseEncumbered}} lbs
            </p>
            <p>
                Heavily Encumbered at:
                {{.Character.InventoryStats.BaseHeavyEncumbered}} lbs
            </p>
            <p>
                Maximum Capacity: {{.Character.InventoryStats.MaximumCapacity}}
                lbs
            </p>
        </div>

        <!-- Equipped Items -->
        {{if .Character.EquippedItems}}
        <div>
            <h3>Equipped Items</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Slot</th>
                        <th>Item</th>
                        <th>Weight</th>
                        <th>Quantity</th>
                        <th>Damage</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Character.EquippedItems}}
                    <tr>
                        <td>{{.SlotName.String}}</td>
                        <td>{{.ItemName}}</td>
                        <td>{{.ItemWeight}} lbs</td>
                        <td>{{.Quantity}}</td>
                        <td>{{if .Damage.Valid}}{{.Damage.String}}{{end}}</td>
                        <td>{{if .Notes}}{{.Notes.String}}{{end}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{end}}

        <!-- Carried Items -->
        {{if .Character.CarriedItems}}
        <div>
            <h3>Carried Items</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Weight</th>
                        <th>Quantity</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Character.CarriedItems}}
                    <tr>
                        <td>{{.ItemName}}</td>
                        <td>{{.ItemWeight}} lbs</td>
                        <td>{{.Quantity}}</td>
                        <td>{{if .Notes}}{{.Notes.String}}{{end}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{end}}

        <!-- Container Contents -->
        {{range $containerId, $items := .Character.ContainerItems}}
        <div>
            <h3>Container Contents</h3>
            <table border="1">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Weight</th>
                        <th>Quantity</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $items}}
                    <tr>
                        <td>{{.ItemName}}</td>
                        <td>{{.ItemWeight}} lbs</td>
                        <td>{{.Quantity}}</td>
                        <td>{{if .Notes}}{{.Notes.String}}{{end}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{end}}
    </div>
</div>
{{end}}
